<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Tripay Integration - Current Setup</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #1a202c;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 2rem;
    }
    .status {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border-left: 4px solid;
    }
    .status.info {
      background: #ebf8ff;
      border-color: #3182ce;
      color: #2c5282;
    }
    .status.success {
      background: #f0fff4;
      border-color: #38a169;
      color: #22543d;
    }
    .status.error {
      background: #fff5f5;
      border-color: #e53e3e;
      color: #742a2a;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .result {
      margin-top: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: #f7fafc;
      border-left: 4px solid #667eea;
    }
    .result pre {
      background: #2d3748;
      color: #68d391;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .checklist {
      list-style: none;
      padding: 0;
    }
    .checklist li {
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
    }
    .checklist li:before {
      content: "‚úì";
      color: #38a169;
      font-weight: bold;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Tripay Integration</h1>
    <p class="subtitle">Test current Vercel API route implementation</p>

    <div class="status info">
      <strong>üìã Prerequisites:</strong>
      <ul class="checklist">
        <li>Logged in to your site</li>
        <li>Have valid user token</li>
        <li>Vercel environment variables set</li>
      </ul>
    </div>

    <div class="form-group">
      <label for="siteUrl">Your Site URL</label>
      <input 
        type="text" 
        id="siteUrl" 
        placeholder="https://your-site.vercel.app"
        value="https://canvango.com"
      >
    </div>

    <div class="form-group">
      <label for="userToken">User Token (from browser console)</label>
      <input 
        type="text" 
        id="userToken" 
        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      >
      <small style="color: #718096; font-size: 0.875rem;">
        Get token: Open browser console ‚Üí Run: <code>supabase.auth.getSession().then(d => console.log(d.data.session.access_token))</code>
      </small>
    </div>

    <div class="form-group">
      <label for="paymentMethod">Payment Method</label>
      <select id="paymentMethod">
        <option value="BRIVA">BRI Virtual Account</option>
        <option value="BCAVA">BCA Virtual Account</option>
        <option value="BNIVA">BNI Virtual Account</option>
        <option value="MANDIRIVA">Mandiri Virtual Account</option>
        <option value="BSIVA">BSI Virtual Account</option>
        <option value="QRIS2">QRIS</option>
      </select>
    </div>

    <div class="form-group">
      <label for="amount">Amount (IDR)</label>
      <input 
        type="number" 
        id="amount" 
        placeholder="50000"
        value="50000"
        min="10000"
        step="1000"
      >
    </div>

    <button class="btn" onclick="testTripay()">
      <span id="btnText">Test Create Transaction</span>
    </button>

    <div id="result"></div>
  </div>

  <script>
    async function testTripay() {
      const siteUrl = document.getElementById('siteUrl').value.trim();
      const userToken = document.getElementById('userToken').value.trim();
      const paymentMethod = document.getElementById('paymentMethod').value;
      const amount = parseInt(document.getElementById('amount').value);
      const resultDiv = document.getElementById('result');
      const btnText = document.getElementById('btnText');
      const btn = document.querySelector('.btn');

      // Validation
      if (!siteUrl) {
        alert('Please enter your site URL');
        return;
      }
      if (!userToken) {
        alert('Please enter your user token');
        return;
      }
      if (amount < 10000) {
        alert('Minimum amount is 10,000 IDR');
        return;
      }

      // Show loading
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span>Testing...';
      resultDiv.innerHTML = '';

      try {
        const payload = {
          amount: amount,
          paymentMethod: paymentMethod,
          customerName: 'Test User',
          customerEmail: 'test@example.com',
          customerPhone: '081234567890',
          orderItems: [
            {
              name: 'Top Up Balance',
              price: amount,
              quantity: 1
            }
          ],
          returnUrl: `${siteUrl}/riwayat-transaksi`,
          expiredTime: 24
        };

        console.log('üöÄ Testing Tripay API:', payload);

        const response = await fetch(`${siteUrl}/api/tripay-proxy`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        console.log('üì¶ Response:', data);

        if (response.ok && data.success) {
          resultDiv.innerHTML = `
            <div class="status success">
              <strong>‚úÖ Success!</strong>
              <p>Transaction created successfully</p>
            </div>
            <div class="result">
              <h3>Payment Details:</h3>
              <ul style="margin-top: 1rem; line-height: 1.8;">
                <li><strong>Reference:</strong> ${data.data.reference}</li>
                <li><strong>Payment Method:</strong> ${data.data.payment_name}</li>
                <li><strong>Amount:</strong> Rp ${data.data.amount.toLocaleString('id-ID')}</li>
                <li><strong>Fee:</strong> Rp ${data.data.total_fee.toLocaleString('id-ID')}</li>
                <li><strong>Total:</strong> Rp ${data.data.amount_received.toLocaleString('id-ID')}</li>
                <li><strong>Status:</strong> ${data.data.status}</li>
                ${data.data.pay_code ? `<li><strong>VA Number:</strong> ${data.data.pay_code}</li>` : ''}
              </ul>
              <p style="margin-top: 1rem;">
                <a href="${data.data.checkout_url}" target="_blank" 
                   style="color: #667eea; font-weight: 600;">
                  ‚Üí Open Payment Page
                </a>
              </p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="status error">
              <strong>‚ùå Error</strong>
              <p>${data.message || 'Failed to create transaction'}</p>
            </div>
            <div class="result">
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
      } catch (error) {
        console.error('‚ùå Error:', error);
        resultDiv.innerHTML = `
          <div class="status error">
            <strong>‚ùå Error</strong>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Test Create Transaction';
      }
    }
  </script>
</body>
</html>
